language: php
matrix:
  fast_finish: true
  include:
    - php: "7.0"
      env: HIDE_STARTUP_ERRORS=0
    - php: "7.1"
      env: HIDE_STARTUP_ERRORS=0
    - php: "7.2"
      env: HIDE_STARTUP_ERRORS=1
    - php: "7.3"
      env: HIDE_STARTUP_ERRORS=1
    - php: "nightly"
      env: HIDE_STARTUP_ERRORS=1
    - php: "master"
      env: HIDE_STARTUP_ERRORS=1
  allow_failures:
    - php: "nightly"
    - php: "master"

os:
 - linux

before_script:
 - git clone git://github.com/jedisct1/libsodium.git
 - cd libsodium
 - ./autogen.sh
 - ./configure --disable-dependency-tracking
 - make
 - sudo make install
 - sudo /sbin/ldconfig
 - cd ..
 - rm -fr libsodium

script:
 - phpize
 - if [[ $HIDE_STARTUP_ERRORS -eq 1 ]]; then ed -i "s/PHP_TEST_SETTINGS = \(\.*\)/PHP_TEST_SETTINGS = -d 'display_startup_errors=0' \1/" Makefile.global; fi
 - ./configure --with-sodium
 - make clean
 - make
 - env NO_INTERACTION=1 make test
